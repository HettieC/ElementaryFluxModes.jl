<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Calculating and differentiating the optimal flux modes (OFMs) in a toy model · ElementaryFluxModes.jl</title><meta name="title" content="Calculating and differentiating the optimal flux modes (OFMs) in a toy model · ElementaryFluxModes.jl"/><meta property="og:title" content="Calculating and differentiating the optimal flux modes (OFMs) in a toy model · ElementaryFluxModes.jl"/><meta property="twitter:title" content="Calculating and differentiating the optimal flux modes (OFMs) in a toy model · ElementaryFluxModes.jl"/><meta name="description" content="Documentation for ElementaryFluxModes.jl."/><meta property="og:description" content="Documentation for ElementaryFluxModes.jl."/><meta property="twitter:description" content="Documentation for ElementaryFluxModes.jl."/><meta property="og:url" content="https://hettiec.github.io/ElementaryFluxModes.jl/3-toy-model-ofm/"/><meta property="twitter:url" content="https://hettiec.github.io/ElementaryFluxModes.jl/3-toy-model-ofm/"/><link rel="canonical" href="https://hettiec.github.io/ElementaryFluxModes.jl/3-toy-model-ofm/"/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">ElementaryFluxModes.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">README</a></li><li><a class="tocitem" href="../1-toy-model/">Calculating EFMs in a toy model</a></li><li><a class="tocitem" href="../2-differentiate/">Sensitivities of the EFMs of a toy model</a></li><li class="is-active"><a class="tocitem" href>Calculating and differentiating the optimal flux modes (OFMs) in a toy model</a><ul class="internal"><li><a class="tocitem" href="#Load-a-simple-model"><span>Load a simple model</span></a></li><li><a class="tocitem" href="#Solve-the-toy-model-with-enzyme-constraints"><span>Solve the toy model with enzyme constraints</span></a></li><li><a class="tocitem" href="#Differentiate-the-OFM-usage"><span>Differentiate the OFM usage</span></a></li></ul></li><li><a class="tocitem" href="../4-ecoli-core/">Sensitivities of OFMs in <em>E. coli</em> core</a></li><li><a class="tocitem" href="../reference/">Reference</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Calculating and differentiating the optimal flux modes (OFMs) in a toy model</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Calculating and differentiating the optimal flux modes (OFMs) in a toy model</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/HettieC/ElementaryFluxModes.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/HettieC/ElementaryFluxModes.jl/blob/main/docs/src/3-toy-model-ofm.jl" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Calculating-and-differentiating-the-optimal-flux-modes-(OFMs)-in-a-toy-model"><a class="docs-heading-anchor" href="#Calculating-and-differentiating-the-optimal-flux-modes-(OFMs)-in-a-toy-model">Calculating and differentiating the optimal flux modes (OFMs) in a toy model</a><a id="Calculating-and-differentiating-the-optimal-flux-modes-(OFMs)-in-a-toy-model-1"></a><a class="docs-heading-anchor-permalink" href="#Calculating-and-differentiating-the-optimal-flux-modes-(OFMs)-in-a-toy-model" title="Permalink"></a></h1><pre><code class="language-julia hljs">using ElementaryFluxModes
import COBREXA as X
import AbstractFBCModels as A
import Tulip as T
import FastDifferentiation as F
const Ex = F.Node
using DataFrames</code></pre><h2 id="Load-a-simple-model"><a class="docs-heading-anchor" href="#Load-a-simple-model">Load a simple model</a><a id="Load-a-simple-model-1"></a><a class="docs-heading-anchor-permalink" href="#Load-a-simple-model" title="Permalink"></a></h2><p>The code used to construct the model is located in <code>test/simple_model.jl</code>, but it is not shown here for brevity.</p><pre><code class="language-julia hljs">model

N = A.stoichiometry(model)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">4×7 SparseArrays.SparseMatrixCSC{Float64, Int64} with 11 stored entries:
   ⋅   1.0   ⋅   -1.0    ⋅     ⋅     ⋅ 
   ⋅    ⋅   1.0  -1.0    ⋅   -1.0    ⋅ 
   ⋅    ⋅    ⋅    1.0  -1.0    ⋅     ⋅ 
 -1.0   ⋅    ⋅     ⋅    1.0   1.0  -1.0</code></pre><p>We wish to add an lower bound on the ATP maintenance proxy reaction, to illustrate how OFMs would work in a bigger model.</p><pre><code class="language-julia hljs">model.reactions[&quot;ATPM&quot;].lower_bound = 10

rid_kcat
kcats = Symbol.(keys(rid_kcat))

float_reaction_isozymes = Dict{String,Dict{String,X.Isozyme}}()
for (rid, rxn) in model.reactions
    grrs = rxn.gene_association_dnf
    isnothing(grrs) &amp;&amp; continue # skip if no grr available
    haskey(rid_kcat, rid) || continue # skip if no kcat data available
    for (i, grr) in enumerate(grrs)

        kcat = rid_kcat[rid] * 3.6 # change unit to k/h

        d = get!(float_reaction_isozymes, rid, Dict{String,X.Isozyme}())
        d[&quot;$(rid)_$i&quot;] = X.Isozyme(
            gene_product_stoichiometry = Dict(grr .=&gt; fill(1.0, size(grr))), # assume subunit stoichiometry of 1 for all isozymes
            kcat_forward = kcat, # assume forward and reverse have the same kcat
            kcat_reverse = nothing,
        )
    end
end

gene_product_molar_masses

capacity</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">2-element Vector{Tuple{String, Vector{String}, Float64}}:
 (&quot;pool_1&quot;, [&quot;g1&quot;, &quot;g2&quot;], 10.0)
 (&quot;pool_2&quot;, [&quot;g3&quot;, &quot;g4&quot;], 10.0)</code></pre><h2 id="Solve-the-toy-model-with-enzyme-constraints"><a class="docs-heading-anchor" href="#Solve-the-toy-model-with-enzyme-constraints">Solve the toy model with enzyme constraints</a><a id="Solve-the-toy-model-with-enzyme-constraints-1"></a><a class="docs-heading-anchor-permalink" href="#Solve-the-toy-model-with-enzyme-constraints" title="Permalink"></a></h2><pre><code class="language-julia hljs">ec_solution = X.enzyme_constrained_flux_balance_analysis(
    model;
    reaction_isozymes = float_reaction_isozymes,
    gene_product_molar_masses,
    capacity,
    optimizer = T.Optimizer,
)

ec_solution.fluxes</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">ConstraintTrees.Tree{Float64} with 7 elements:
  :ATPM =&gt; 10.0
  :r1   =&gt; 180.0
  :r2   =&gt; 270.0
  :r3   =&gt; 180.0
  :r4   =&gt; 180.0
  :r5   =&gt; 90.0
  :r6   =&gt; 260.0</code></pre><p>This optimal solution uses every reaction in the model, and since we have an enzyme capacity with two enzyme pools, theory has shown that there must be two OFMs in this optimal solution, and the optimal proportion of their flux is unique.</p><p>To calculate these OFMs, we require the index and optimal value of ATPM and the objective reaction r6</p><pre><code class="language-julia hljs">atpm_idx = findfirst(x -&gt; x == &quot;ATPM&quot;, A.reactions(model))
biomass_idx = findfirst(x -&gt; x == &quot;r6&quot;, A.reactions(model))
fixed_fluxes = [atpm_idx, biomass_idx]
flux_values = [ec_solution.fluxes[&quot;ATPM&quot;], ec_solution.fluxes[&quot;r6&quot;]]</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">2-element Vector{Float64}:
  10.000000003628772
 259.99999998916263</code></pre><p>Calculate OFMs</p><pre><code class="language-julia hljs">OFMs = get_ofms(Matrix(N), fixed_fluxes, flux_values)


OFM_dicts =
    [Dict(A.reactions(model) .=&gt; OFMs[:, 1]), Dict(A.reactions(model) .=&gt; OFMs[:, 2])]</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">2-element Vector{Dict{String, Float64}}:
 Dict(&quot;r1&quot; =&gt; 269.9999999927914, &quot;r2&quot; =&gt; 269.9999999927914, &quot;r5&quot; =&gt; 0.0, &quot;ATPM&quot; =&gt; 10.000000003628772, &quot;r6&quot; =&gt; 259.99999998916263, &quot;r3&quot; =&gt; 269.9999999927914, &quot;r4&quot; =&gt; 269.9999999927914)
 Dict(&quot;r1&quot; =&gt; 0.0, &quot;r2&quot; =&gt; 269.9999999927914, &quot;r5&quot; =&gt; 269.9999999927914, &quot;ATPM&quot; =&gt; 10.000000003628772, &quot;r6&quot; =&gt; 259.99999998916263, &quot;r3&quot; =&gt; 0.0, &quot;r4&quot; =&gt; 0.0)</code></pre><p>We see that the first OFM uses reactions 1,2,3,4,6 and ATPM, and the second OFM uses reactions 2,5,6 and ATPM.</p><pre><code class="language-julia hljs">OFM_dicts = [
    Dict(x =&gt; y / OFM_dicts[1][&quot;r6&quot;] for (x, y) in OFM_dicts[1]),
    Dict(x =&gt; y / OFM_dicts[2][&quot;r6&quot;] for (x, y) in OFM_dicts[2]),
]</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">2-element Vector{Dict{String, Float64}}:
 Dict(&quot;r1&quot; =&gt; 1.0384615384770983, &quot;r2&quot; =&gt; 1.0384615384770983, &quot;r5&quot; =&gt; 0.0, &quot;ATPM&quot; =&gt; 0.03846153847709844, &quot;r6&quot; =&gt; 1.0, &quot;r3&quot; =&gt; 1.0384615384770983, &quot;r4&quot; =&gt; 1.0384615384770983)
 Dict(&quot;r1&quot; =&gt; 0.0, &quot;r2&quot; =&gt; 1.0384615384770983, &quot;r5&quot; =&gt; 1.0384615384770983, &quot;ATPM&quot; =&gt; 0.03846153847709844, &quot;r6&quot; =&gt; 1.0, &quot;r3&quot; =&gt; 0.0, &quot;r4&quot; =&gt; 0.0)</code></pre><p>Calculate proportion of the OFMs used in the optimal solution</p><pre><code class="language-julia hljs">M = [
    OFM_dicts[1][&quot;r5&quot;] OFM_dicts[2][&quot;r5&quot;]
    OFM_dicts[1][&quot;r1&quot;] OFM_dicts[2][&quot;r1&quot;]
]

v = [
    ec_solution.fluxes[&quot;r5&quot;]
    ec_solution.fluxes[&quot;r1&quot;]
]

λ = M \ v</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">2-element Vector{Float64}:
 173.33333332489386
  86.66666666426643</code></pre><p>Two thirds of the optimal flux is provided by the first OFM (using r2 and r3), and the remaining third by the second OFM (using r4).</p><h2 id="Differentiate-the-OFM-usage"><a class="docs-heading-anchor" href="#Differentiate-the-OFM-usage">Differentiate the OFM usage</a><a id="Differentiate-the-OFM-usage-1"></a><a class="docs-heading-anchor-permalink" href="#Differentiate-the-OFM-usage" title="Permalink"></a></h2><p>It remains to differentiate to find the sensitivities of the OFM usage to the model parameters. For this, we must set up parameter isozymes.</p><pre><code class="language-julia hljs">parameter_values = Dict(
    Symbol(x) =&gt; iso.kcat_forward for (x, y) in float_reaction_isozymes for (_, iso) in y
)

parameters = Ex.(collect(keys(parameter_values)))
rid_gcounts = Dict(
    rid =&gt; [v.gene_product_stoichiometry for (k, v) in d][1] for
    (rid, d) in float_reaction_isozymes
)
rid_pid = Dict(rid =&gt; Ex(Symbol(rid)) for (rid, _) in rid_kcat)


sens = differentiate_ofm(
    OFM_dicts,
    parameters,
    rid_pid,
    parameter_values,
    rid_gcounts,
    capacity,
    gene_product_molar_masses,
    T.Optimizer,
)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">2×3 Matrix{Float64}:
  2.40741  -0.0       2.40741
 -0.0       4.81481  -0.0</code></pre><p>We may scale these sensitivities to calculate the control coefficients, (p/λ)*dλ/dp</p><pre><code class="language-julia hljs">control = Matrix(undef, size(sens, 1), size(sens, 2))
for (i, col) in enumerate(eachcol(sens))
    control[:, i] = collect(values(parameter_values))[i] .* col ./ λ
end
control</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">2×3 Matrix{Any}:
  0.5  -0.0   0.5
 -0.0   1.0  -0.0</code></pre><p>We now use the order of <code>parameters</code> to put this data into a DataFrame and see that reaction 3 and 4 control the usae of the first OFM, whereas reaction 5 controls the usage of the second OFM. Increasing the kcat value of reaction 3 by 1% would increase the flux through OFM₁ by 0.5%, increasing the kcat of reaction 4 by 1% would have the same effect, and increasing the kcat of reaction 5 by 1% would increase the flux through OFM₂ by 1%.</p><pre><code class="language-julia hljs">df = DataFrame(
    Variable = [&quot;λ₁&quot;, &quot;λ₂&quot;],
    r3 = control[:, 1],
    r4 = control[:, 3],
    r5 = control[:, 2],
)</code></pre><div><div style = "float: left;"><span>2×4 DataFrame</span></div><div style = "clear: both;"></div></div><div class = "data-frame" style = "overflow-x: scroll;"><table class = "data-frame" style = "margin-bottom: 6px;"><thead><tr class = "header"><th class = "rowNumber" style = "font-weight: bold; text-align: right;">Row</th><th style = "text-align: left;">Variable</th><th style = "text-align: left;">r3</th><th style = "text-align: left;">r4</th><th style = "text-align: left;">r5</th></tr><tr class = "subheader headerLastRow"><th class = "rowNumber" style = "font-weight: bold; text-align: right;"></th><th title = "String" style = "text-align: left;">String</th><th title = "Any" style = "text-align: left;">Any</th><th title = "Any" style = "text-align: left;">Any</th><th title = "Any" style = "text-align: left;">Any</th></tr></thead><tbody><tr><td class = "rowNumber" style = "font-weight: bold; text-align: right;">1</td><td style = "text-align: left;">λ₁</td><td style = "text-align: left;">0.5</td><td style = "text-align: left;">0.5</td><td style = "text-align: left;">-0.0</td></tr><tr><td class = "rowNumber" style = "font-weight: bold; text-align: right;">2</td><td style = "text-align: left;">λ₂</td><td style = "text-align: left;">-0.0</td><td style = "text-align: left;">-0.0</td><td style = "text-align: left;">1.0</td></tr></tbody></table></div><hr/><p><em>This page was generated using <a href="https://github.com/fredrikekre/Literate.jl">Literate.jl</a>.</em></p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../2-differentiate/">« Sensitivities of the EFMs of a toy model</a><a class="docs-footer-nextpage" href="../4-ecoli-core/">Sensitivities of OFMs in <em>E. coli</em> core »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.10.0 on <span class="colophon-date" title="Monday 31 March 2025 09:18">Monday 31 March 2025</span>. Using Julia version 1.11.4.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
